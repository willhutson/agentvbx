[supervisord]
nodaemon=true
logfile=%(ENV_HOME)s/agentvbx/logs/supervisord.log
logfile_maxbytes=10MB
logfile_backups=5
pidfile=%(ENV_HOME)s/agentvbx/supervisord.pid

[unix_http_server]
file=%(ENV_HOME)s/agentvbx/supervisor.sock

[supervisorctl]
serverurl=unix://%(ENV_HOME)s/agentvbx/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; ─── Core Orchestrator ───────────────────────────────────────────────────────

[program:orchestrator]
command=node %(ENV_HOME)s/agentvbx/packages/orchestrator/dist/index.js
directory=%(ENV_HOME)s/agentvbx
autostart=true
autorestart=true
startretries=5
startsecs=5
stopwaitsecs=10
stdout_logfile=%(ENV_HOME)s/agentvbx/logs/orchestrator.log
stderr_logfile=%(ENV_HOME)s/agentvbx/logs/orchestrator-error.log
environment=NODE_ENV="production",LOG_LEVEL="info"

; ─── Redis ───────────────────────────────────────────────────────────────────

[program:redis]
command=redis-server --port 6379 --appendonly yes --dir %(ENV_HOME)s/agentvbx/data
autostart=true
autorestart=true
startretries=3
startsecs=2
stdout_logfile=%(ENV_HOME)s/agentvbx/logs/redis.log
stderr_logfile=%(ENV_HOME)s/agentvbx/logs/redis-error.log

; ─── Ollama ──────────────────────────────────────────────────────────────────

[program:ollama]
command=ollama serve
autostart=true
autorestart=true
startretries=3
startsecs=5
stdout_logfile=%(ENV_HOME)s/agentvbx/logs/ollama.log
stderr_logfile=%(ENV_HOME)s/agentvbx/logs/ollama-error.log
environment=OLLAMA_HOST="127.0.0.1:11434"

; ─── WhatsApp Client ────────────────────────────────────────────────────────

[program:whatsapp]
command=node %(ENV_HOME)s/agentvbx/packages/whatsapp/dist/index.js
directory=%(ENV_HOME)s/agentvbx
autostart=false
autorestart=true
startretries=3
startsecs=10
stdout_logfile=%(ENV_HOME)s/agentvbx/logs/whatsapp.log
stderr_logfile=%(ENV_HOME)s/agentvbx/logs/whatsapp-error.log
environment=NODE_ENV="production"

; ─── Telnyx Webhook Server ──────────────────────────────────────────────────

[program:voice-webhook]
command=node %(ENV_HOME)s/agentvbx/packages/voice/dist/index.js
directory=%(ENV_HOME)s/agentvbx
autostart=false
autorestart=true
startretries=3
startsecs=5
stdout_logfile=%(ENV_HOME)s/agentvbx/logs/voice.log
stderr_logfile=%(ENV_HOME)s/agentvbx/logs/voice-error.log
environment=NODE_ENV="production",PORT="3001"

; ─── Process Groups ──────────────────────────────────────────────────────────

[group:core]
programs=orchestrator,redis,ollama
priority=10

[group:channels]
programs=whatsapp,voice-webhook
priority=20
