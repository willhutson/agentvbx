<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no" />
  <meta name="theme-color" content="#0a0a0a" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="/manifest.json" />
  <title>AGENTVBX</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    :root {
      --bg: #0a0a0a; --surface: #111; --card: #151515; --border: #222;
      --text: #e0e0e0; --muted: #888; --dim: #555;
      --accent: #6c7aff; --accent-bg: #1a1a2e;
      --green: #4ade80; --green-bg: #0a2a0a;
      --yellow: #facc15; --red: #f87171; --red-bg: #2a0a0a;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Segoe UI', sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100dvh; overflow-x: hidden;
      padding-top: var(--safe-top); padding-bottom: var(--safe-bottom);
    }

    /* ── Header ── */
    .header {
      position: sticky; top: 0; z-index: 100;
      background: rgba(10,10,10,0.85); backdrop-filter: blur(20px);
      padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;
      border-bottom: 1px solid var(--border);
    }
    .header h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.5px; }
    .header-right { display: flex; gap: 8px; align-items: center; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--red); }
    .dot.on { background: var(--green); }
    .badge {
      font-size: 10px; padding: 3px 8px; border-radius: 10px; font-weight: 600;
      background: var(--green-bg); color: var(--green);
    }
    .badge.warn { background: #2a2a0a; color: var(--yellow); }

    /* ── Tab Bar ── */
    .tabs {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: rgba(10,10,10,0.92); backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      display: flex; justify-content: space-around;
      padding: 6px 0 calc(6px + var(--safe-bottom));
    }
    .tab {
      display: flex; flex-direction: column; align-items: center; gap: 2px;
      padding: 4px 12px; font-size: 10px; color: var(--dim); cursor: pointer;
      transition: color 0.15s;
    }
    .tab.active { color: var(--accent); }
    .tab svg { width: 22px; height: 22px; }

    /* ── Content ── */
    .content { padding: 12px 16px 80px; }

    /* ── Cards ── */
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: 14px; margin-bottom: 10px;
    }
    .card h3 {
      font-size: 10px; text-transform: uppercase; letter-spacing: 1px;
      color: var(--dim); margin-bottom: 8px;
    }
    .stat-row { display: flex; justify-content: space-between; padding: 4px 0; font-size: 13px; }
    .stat-row .label { color: var(--muted); }
    .stat-row .value { font-weight: 600; font-variant-numeric: tabular-nums; }

    /* ── Pills ── */
    .pills { display: flex; flex-wrap: wrap; gap: 6px; }
    .pill {
      font-size: 11px; padding: 3px 10px; border-radius: 12px;
      background: var(--accent-bg); color: var(--accent); border: 1px solid #2a2a4e;
    }
    .pill.green { background: #0a2a0a; color: var(--green); border-color: #1a3a1a; }

    /* ── Chat View ── */
    .chat { display: none; flex-direction: column; height: calc(100dvh - 100px); }
    .chat.visible { display: flex; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 12px 0; }
    .msg {
      max-width: 85%; margin: 4px 0; padding: 10px 14px; border-radius: 16px;
      font-size: 14px; line-height: 1.4; word-break: break-word;
    }
    .msg.user { background: var(--accent); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
    .msg.bot { background: var(--card); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
    .msg .agent-tag { font-size: 10px; color: var(--dim); margin-bottom: 2px; }
    .chat-input {
      display: flex; gap: 8px; padding: 8px 0;
      border-top: 1px solid var(--border);
    }
    .chat-input input {
      flex: 1; background: var(--card); border: 1px solid var(--border);
      border-radius: 20px; padding: 10px 16px; color: var(--text); font-size: 14px;
      outline: none;
    }
    .chat-input input:focus { border-color: var(--accent); }
    .chat-input button {
      width: 40px; height: 40px; border-radius: 50%;
      background: var(--accent); border: none; color: #fff; font-size: 16px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }

    /* ── Feed ── */
    .feed-item {
      padding: 8px 0; border-bottom: 1px solid #1a1a1a;
      font-size: 12px; display: flex; gap: 8px; align-items: baseline;
    }
    .feed-time { color: var(--dim); width: 48px; flex-shrink: 0; font-variant-numeric: tabular-nums; }

    /* ── Recipes ── */
    .recipe-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: 14px; margin-bottom: 8px; cursor: pointer;
    }
    .recipe-card h4 { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
    .recipe-card p { font-size: 11px; color: var(--muted); }
    .recipe-meta { display: flex; gap: 12px; margin-top: 6px; font-size: 10px; color: var(--dim); }

    /* ── View Toggles ── */
    .view { display: none; }
    .view.active { display: block; }

    /* ── Empty state ── */
    .empty { text-align: center; padding: 40px 20px; color: var(--dim); font-size: 13px; }
  </style>
</head>
<body>

  <div class="header">
    <h1>AGENTVBX</h1>
    <div class="header-right">
      <div class="dot" id="ws-dot"></div>
      <div class="badge" id="status-badge">Connecting</div>
    </div>
  </div>

  <div class="content">
    <!-- ── Dashboard View ── -->
    <div class="view active" id="view-dashboard">
      <div class="card">
        <h3>Queue</h3>
        <div class="stat-row"><span class="label">Voice</span><span class="value" id="q-voice">0</span></div>
        <div class="stat-row"><span class="label">Chat</span><span class="value" id="q-chat">0</span></div>
        <div class="stat-row"><span class="label">Background</span><span class="value" id="q-bg">0</span></div>
      </div>

      <div class="card">
        <h3>System</h3>
        <div class="stat-row"><span class="label">Uptime</span><span class="value" id="s-up">-</span></div>
        <div class="stat-row"><span class="label">Memory</span><span class="value" id="s-mem">-</span></div>
        <div class="stat-row"><span class="label">Sessions</span><span class="value" id="s-ws">0</span></div>
      </div>

      <div class="card">
        <h3>Agents</h3>
        <div class="pills" id="agents"></div>
        <div class="empty" id="agents-empty">No agents</div>
      </div>

      <div class="card">
        <h3>Adapters</h3>
        <div class="pills" id="adapters"></div>
        <div class="empty" id="adapters-empty">No adapters</div>
      </div>

      <div class="card">
        <h3>Activity</h3>
        <div id="feed"></div>
        <div class="empty" id="feed-empty">Waiting for events...</div>
      </div>
    </div>

    <!-- ── Chat View ── -->
    <div class="view" id="view-chat">
      <div class="chat visible">
        <div class="chat-messages" id="chat-messages">
          <div class="empty">Send a message to start...</div>
        </div>
        <div class="chat-input">
          <input type="text" id="chat-input" placeholder="Message your agents..." autocomplete="off" />
          <button id="chat-send" aria-label="Send">&#x2191;</button>
        </div>
      </div>
    </div>

    <!-- ── Recipes View ── -->
    <div class="view" id="view-recipes">
      <div id="recipes-list"></div>
      <div class="empty" id="recipes-empty">No recipes loaded</div>
    </div>

    <!-- ── Settings View ── -->
    <div class="view" id="view-settings">
      <div class="card">
        <h3>Connection</h3>
        <div class="stat-row"><span class="label">API</span><span class="value" id="set-api">-</span></div>
        <div class="stat-row"><span class="label">WebSocket</span><span class="value" id="set-ws">-</span></div>
        <div class="stat-row"><span class="label">Version</span><span class="value" id="set-ver">-</span></div>
      </div>
      <div class="card">
        <h3>Notifications</h3>
        <div class="stat-row">
          <span class="label">Push notifications</span>
          <span class="value"><button onclick="requestPush()" style="background:var(--accent);color:#fff;border:none;padding:4px 12px;border-radius:8px;font-size:11px;cursor:pointer">Enable</button></span>
        </div>
      </div>
      <div class="card">
        <h3>About</h3>
        <div class="stat-row"><span class="label">Phase</span><span class="value">5-7</span></div>
        <div class="stat-row"><span class="label">Build</span><span class="value">v0.5.0</span></div>
      </div>
    </div>
  </div>

  <!-- ── Tab Bar ── -->
  <div class="tabs">
    <div class="tab active" data-view="dashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Home
    </div>
    <div class="tab" data-view="chat">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Chat
    </div>
    <div class="tab" data-view="recipes">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>
      Recipes
    </div>
    <div class="tab" data-view="settings">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
      Settings
    </div>
  </div>

  <script>
    // ── Config ──
    const API = window.location.origin;
    const WS_URL = `ws://${window.location.host}/ws`;
    let ws = null;
    const feed = [];

    // ── Service Worker ──
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }

    // ── Tab Navigation ──
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('view-' + tab.dataset.view).classList.add('active');
      });
    });

    // ── WebSocket ──
    function connectWS() {
      try {
        ws = new WebSocket(WS_URL);
        ws.onopen = () => {
          document.getElementById('ws-dot').classList.add('on');
          document.getElementById('set-ws').textContent = 'Connected';
        };
        ws.onclose = () => {
          document.getElementById('ws-dot').classList.remove('on');
          document.getElementById('set-ws').textContent = 'Disconnected';
          setTimeout(connectWS, 3000);
        };
        ws.onmessage = (e) => {
          try { handleEvent(JSON.parse(e.data)); } catch {}
        };
      } catch { setTimeout(connectWS, 3000); }
    }

    function handleEvent(ev) {
      if (ev.type === 'health') updateHealth(ev.data);
      addFeed(ev.type, ev.data);
    }

    // ── Health ──
    async function fetchHealth() {
      try {
        const r = await fetch(API + '/api/health');
        if (r.ok) updateHealth(await r.json());
      } catch {}
    }

    async function fetchSystem() {
      try {
        const r = await fetch(API + '/api/system');
        if (r.ok) {
          const s = await r.json();
          document.getElementById('s-up').textContent = fmtUp(s.uptime);
          document.getElementById('s-mem').textContent = fmtMB(s.memory?.rss);
          document.getElementById('s-ws').textContent = s.ws_clients ?? 0;
          document.getElementById('set-api').textContent = API;
          document.getElementById('set-ver').textContent = s.version;
        }
      } catch {}
    }

    async function fetchRecipes() {
      try {
        const r = await fetch(API + '/api/recipes');
        if (r.ok) {
          const recipes = await r.json();
          const el = document.getElementById('recipes-list');
          const em = document.getElementById('recipes-empty');
          if (recipes.length) {
            em.style.display = 'none';
            el.innerHTML = recipes.map(r => `
              <div class="recipe-card">
                <h4>${esc(r.name)}</h4>
                <p>${esc(r.description || '')}</p>
                <div class="recipe-meta">
                  <span>${r.steps?.length ?? 0} steps</span>
                  <span>${r.trigger?.type ?? 'manual'}</span>
                </div>
              </div>
            `).join('');
          }
        }
      } catch {}
    }

    function updateHealth(h) {
      const badge = document.getElementById('status-badge');
      const s = h.status || 'unknown';
      badge.textContent = s.charAt(0).toUpperCase() + s.slice(1);
      badge.className = 'badge' + (s === 'healthy' ? '' : ' warn');

      if (h.queue) {
        document.getElementById('q-voice').textContent = h.queue.voice ?? 0;
        document.getElementById('q-chat').textContent = h.queue.chat ?? 0;
        document.getElementById('q-bg').textContent = h.queue.background ?? 0;
      }
      if (h.agents) {
        const el = document.getElementById('agents');
        const em = document.getElementById('agents-empty');
        if (h.agents.length) {
          em.style.display = 'none';
          el.innerHTML = h.agents.map(a => `<span class="pill">${esc(a)}</span>`).join('');
        }
      }
      if (h.adapters) {
        const el = document.getElementById('adapters');
        const em = document.getElementById('adapters-empty');
        if (h.adapters.length) {
          em.style.display = 'none';
          el.innerHTML = h.adapters.map(a => `<span class="pill green">${esc(a)}</span>`).join('');
        }
      }
    }

    // ── Feed ──
    function addFeed(type, data) {
      const t = new Date().toLocaleTimeString('en', { hour12: false, hour: '2-digit', minute: '2-digit' });
      feed.unshift({ t, text: type });
      if (feed.length > 50) feed.length = 50;
      const el = document.getElementById('feed');
      const em = document.getElementById('feed-empty');
      em.style.display = 'none';
      el.innerHTML = feed.map(f => `<div class="feed-item"><span class="feed-time">${f.t}</span><span>${esc(f.text)}</span></div>`).join('');
    }

    // ── Chat ──
    document.getElementById('chat-send').addEventListener('click', sendChat);
    document.getElementById('chat-input').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendChat();
    });

    async function sendChat() {
      const input = document.getElementById('chat-input');
      const text = input.value.trim();
      if (!text) return;
      input.value = '';

      appendMsg('user', text);

      try {
        const r = await fetch(API + '/api/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tenant_id: 'default',
            number_id: 'mobile',
            channel: 'app',
            from: 'mobile-user',
            to: 'system',
            text,
          }),
        });
        if (r.ok) {
          const d = await r.json();
          appendMsg('bot', `Queued: ${d.queue_id}`, 'system');
        }
      } catch {
        appendMsg('bot', 'Failed to send message', 'error');
      }
    }

    function appendMsg(role, text, agent) {
      const el = document.getElementById('chat-messages');
      el.querySelector('.empty')?.remove();
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      div.innerHTML = (agent ? `<div class="agent-tag">${esc(agent)}</div>` : '') + esc(text);
      el.appendChild(div);
      el.scrollTop = el.scrollHeight;
    }

    // ── Push ──
    async function requestPush() {
      if (!('Notification' in window)) return;
      const perm = await Notification.requestPermission();
      if (perm === 'granted') {
        const reg = await navigator.serviceWorker.ready;
        // In production: subscribe to VAPID push server
        alert('Push notifications enabled');
      }
    }

    // ── Helpers ──
    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function fmtUp(s) { return s ? `${Math.floor(s/3600)}h ${Math.floor((s%3600)/60)}m` : '-'; }
    function fmtMB(b) { return b ? `${(b/1024/1024).toFixed(0)} MB` : '-'; }

    // ── Init ──
    connectWS(); fetchHealth(); fetchSystem(); fetchRecipes();
    setInterval(fetchHealth, 5000);
    setInterval(fetchSystem, 15000);
  </script>
</body>
</html>
